<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 2em auto 0; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="480" height="600" style="border:1px solid #000000;" ></canvas>

<script>
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");

ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, canvas.width-1, canvas.height-1);


var array_bullet = [];
var array_alien = [];
var array_explode = [];
var array_ship = [];
var all_array = [array_bullet, array_explode, array_alien, array_ship];	// for looping purpose

var ball_interval;	// setInterval of shoot when mouse pressed

var isFired = false;	// prevents spacebar shoot from being stucked

var ship_image = new Image();
ship_image.src = './ship.png';
var ship_x = canvas.width / 2;
var ship_y = canvas.height - 50;
var ship_size = 80;
var ship_radius = ship_size / 2;


var explosion_image = new Image();
explosion_image.src = './explode.png';

var explode_sound = new Audio('./explode.mp3');
var gun_sound = new Audio('./gun.mp3');


var globalX = canvas.width / 2;  // location of ship when it moves
var globalY = canvas.height - 50;  // location of ship when it moves
function ScreenTimer() {
	
    // clear drawings
    ctx.fillStyle = "#ffffff";
	ctx.fillRect(0, 0, canvas.width, canvas.height);
	
    for(var i=0; i<all_array.length; i++) {
		
		var current_array = all_array[i];
		
		for(var p=0; p<current_array.length; p++) {
			
			if ('checkIfDead' in current_array[p]) {
				current_array[p].checkIfDead();
			}
			
			// remove to array when dead
			if (current_array[p].Trigger()==false) {
				current_array.splice(p, 1);
				p--;
			}
			
		}
		
    }
	
    requestAnimationFrame(ScreenTimer);
}

class alien {
    constructor(x) {
        this.x = x;
        this.y = 50;
        this.ballRadius = 20;
		this.isDead = 0;
    }
	
	checkIfDead() {
		for(var i=0;i<array_bullet.length;i++) {
			
			var distancex = this.x - array_bullet[i].x;
			var distancey = this.y - array_bullet[i].y;
			var distance = Math.sqrt((distancex * distancex) + (distancey * distancey));
			if (distance < this.ballRadius + array_bullet[i].ballRadius) {
				// set alien and bullet dead
				this.isDead = 1;
				array_bullet[i].isDead = 1;
			}
		}
	}
	
    Trigger()
    {
        if (!this.isDead) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.ballRadius, 0, Math.PI*2);
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.closePath();
        }
        else {
			var explode_object = new explode(this.x, this.y);
			array_explode.push(explode_object);
			
			// play explode sound
			explode_sound.pause();
			explode_sound.currentTime = 0;
			explode_sound.play();
            return false;
		}
        // The object is movine, return true
        
        return true;
    }
};

class bullet {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.dx = 0;
        this.dy = -14;
        this.ballRadius = 5;
		this.isDead = 0;
    }

    Trigger()
    {
        if (this.y > 0 && !this.isDead)
        {
            this.y += this.dy;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.ballRadius, 0, Math.PI*2);
            ctx.fillStyle = "#0095DD";
            ctx.fill();
            ctx.closePath();

        }
        else
            return false;
        // The object is movine, return true
        
        return true;
    }
};

class explode {
    constructor(x, y) {
        this.x = x;
        this.y = y;
		this.isDead = 0;
		this.sprite_x = 0;
		this.sprite_y = 0;
    }

    Trigger()
    {
        if (!this.isDead)
        {
			// remove object if sprite reaches the last
			if (this.sprite_x / 128 == 4 && this.sprite_y / 128 == 4) {
				this.isDead = 1;
			}
			// switch to lower part of sprite
			else if (this.sprite_x / 128 == 4) {
				this.sprite_x = 0;
				this.sprite_y += 128;
			}
			
			ctx.drawImage(
			   explosion_image,
			   this.sprite_x,
			   this.sprite_y,
			   128,
			   128,
			   this.x - 40,
			   this.y - 40,
			   80,
			   80);
			this.sprite_x += 128;
			
			
        }
        else
            return false;
        // The object is movine, return true
        
        return true;
    }
};

class ship {
    constructor() {
        this.x = ship_x;
        this.y = ship_y;
        this.dx = 0;
        this.dy = 0;
        this.ballRadius = 5;
		this.isDead = 0;
    }

    Trigger()
    {
        if (!this.isDead)
        {
			ctx.drawImage(
			   ship_image,
			   this.x - 40,
			   this.y - 40,
			   ship_size,
			   ship_size);
        }
        else
            return false;
        // The object is movine, return true
        
        return true;
    }
};

function shoot(x, y) {
	
	var bullet_object = new bullet(x, y);
    array_bullet.push(bullet_object);
	
	// play gun sound
	gun_sound.pause();
	gun_sound.currentTime = 0;
	gun_sound.play();
}


function init() {
	var spaces = 50;
	
	var ship_object = new ship();
	array_ship.push(ship_object);
	
	for (var i=0; i<10; i++) {
		var alien_object = new alien(spaces);
		array_alien.push(alien_object);
		spaces += 50;
	}
}

// use it like a timer
ScreenTimer();
init();



window.onkeydown = function(e) {
	if (!isFired) { 
		if(event.keyCode == 32) { 	// spacebar
			ball_interval = setInterval(function(){ shoot(globalX, globalY) }, 80); 
			
		}
		isFired = true;
	}
	
	
	if(event.keyCode == 37 && !(array_ship[0].x <= 0 + ship_radius)) { 	// left
		array_ship[0].x -= 10;
		globalX = array_ship[0].x;
	}
	
	else if(event.keyCode == 38) { 	// up
		array_ship[0].y -= 10;
		globalY = array_ship[0].y;
	}
	
	else if(event.keyCode == 39 && !(array_ship[0].x >= canvas.width - ship_radius)) { 	// right
		array_ship[0].x += 10;
		globalX = array_ship[0].x;
	}
	
	else if(event.keyCode == 40 && !(array_ship[0].y >= canvas.height - ship_radius)) { 	// down
		array_ship[0].y += 10;
		globalY = array_ship[0].y;
	}
}

window.onkeyup = function(e) { 
	isFired = false;
	if(event.keyCode == 32) { 	// spacebar
		clearInterval(ball_interval);
	}
    
}


</script>

</body>
</html>
